<!DOCTYPE html>
<html>
<head>
    <title>EcoPack AI Dashboard</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">

<div class="container mt-5">

    <h2 class="text-center mb-4">üìà Sustainability Intelligence Dashboard</h2>

    <!-- ================= KPI METRICS ================= -->
    <div class="row text-center mb-4">

        <div class="col-md-3">
            <div class="card shadow p-3">
                <h6>üåç Avg CO‚ÇÇ</h6>
                <h4 id="avgCO2">--</h4>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow p-3">
                <h6>üí∞ Avg Cost</h6>
                <h4 id="avgCost">--</h4>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow p-3">
                <h6>üìâ CO‚ÇÇ Reduction %</h6>
                <h4 id="co2Reduction">--</h4>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow p-3">
                <h6>üíµ Cost Savings %</h6>
                <h4 id="costSavings">--</h4>
            </div>
        </div>

    </div>


    <!-- ================= CHARTS ROW 1 ================= -->
    <div class="row mt-4">

        <div class="col-md-6">
            <div class="card shadow p-3">
                <h5 class="text-center">Top 5 Cost Comparison</h5>
                <canvas id="costChart"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow p-3">
                <h5 class="text-center">Top 5 CO‚ÇÇ Comparison</h5>
                <canvas id="co2Chart"></canvas>
            </div>
        </div>

    </div>


    <!-- ================= CHARTS ROW 2 ================= -->
    <div class="row mt-4">

        <div class="col-md-6">
            <div class="card shadow p-3">
                <h5 class="text-center">Suitability Comparison</h5>
                <canvas id="suitabilityChart"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow p-3">
                <h5 class="text-center">Material Usage Trend</h5>
                <canvas id="usageChart"></canvas>
            </div>
        </div>

    </div>


    <!-- ================= EXPORT BUTTONS ================= -->
    <div class="mt-5 text-center">
        <button onclick="exportPDF()" class="btn btn-danger me-2">
            Export PDF Report
        </button>
        <button onclick="exportExcel()" class="btn btn-success me-2">
            Export Excel Report
        </button>
        <a href="/" class="btn btn-secondary">
            Back to Recommendation
        </a>
    </div>

</div>


<script>

    // ===============================
    // LOAD KPI METRICS
    // ===============================
    async function loadMetrics() {
        const response = await fetch("/api/dashboard-metrics");
        const data = await response.json();

        document.getElementById("avgCO2").innerText =
            data.avg_co2 + " kg";

        document.getElementById("avgCost").innerText =
            "‚Çπ " + data.avg_cost;

        document.getElementById("co2Reduction").innerText =
            data.co2_reduction_percent + " %";

        document.getElementById("costSavings").innerText =
            data.cost_savings_percent + " %";
    }


    // ===============================
    // LOAD CHARTS (FIXED VERSION)
    // ===============================
    async function loadCharts() {

        const response = await fetch("/api/trends");
        const data = await response.json();

        console.log("Trends Data:", data);

        // Extract comparison array
        const materials = data.comparison.map(item => item.material_name);
        const costs = data.comparison.map(item => item.cost_rupees);
        const co2 = data.comparison.map(item => item.co2_score);
        const suitability = data.comparison.map(item => item.suitability_score);

        // Extract usage trend
        const usageMaterials = data.usage_trend.map(item => item.material_name);
        const usageCounts = data.usage_trend.map(item => item.count);

        // COST CHART
        new Chart(document.getElementById("costChart"), {
            type: "bar",
            data: {
                labels: materials,
                datasets: [{
                    label: "Cost (‚Çπ)",
                    data: costs
                }]
            }
        });

        // CO2 CHART
        new Chart(document.getElementById("co2Chart"), {
            type: "bar",
            data: {
                labels: materials,
                datasets: [{
                    label: "CO‚ÇÇ Score",
                    data: co2
                }]
            }
        });

        // SUITABILITY CHART
        new Chart(document.getElementById("suitabilityChart"), {
            type: "line",
            data: {
                labels: materials,
                datasets: [{
                    label: "Suitability Score",
                    data: suitability
                }]
            }
        });

        // USAGE TREND
        new Chart(document.getElementById("usageChart"), {
            type: "bar",
            data: {
                labels: usageMaterials,
                datasets: [{
                    label: "Usage Count",
                    data: usageCounts
                }]
            }
        });
    }


    function exportPDF() {
        window.open("/api/export/pdf", "_blank");
    }

    function exportExcel() {
        window.open("/api/export/excel", "_blank");
    }

    loadMetrics();
    loadCharts();

</script>

</body>
</html>
